<div class="product-management-container">
  <div class="page-header">
    <h1 class="page-title">Product Management</h1>
    <div class="header-actions">
      <button class="btn btn-primary" (click)="openCreateForm()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="8" x2="12" y2="16"/>
          <line x1="8" y1="12" x2="16" y2="12"/>
        </svg>
        Add New Product
      </button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <div class="filters-grid">
      <div class="filter-group">
        <label for="search">Search Products</label>
        <div class="search-input-wrapper">
          <input
            type="text"
            id="search"
            [(ngModel)]="searchQuery"
            [ngModelOptions]="{ standalone: true }"
            (keyup.enter)="onSearch()"
            placeholder="Search by name, description..."
            class="form-control search-input"
          />
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="search-icon">
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.35-4.35"/>
          </svg>
        </div>
      </div>

      <div class="filter-group">
        <label for="category">Category</label>
        <select
          id="category"
          [(ngModel)]="categoryFilter"
          [ngModelOptions]="{ standalone: true }"
          (change)="onCategoryFilterChange()"
          class="form-control category-filter"
        >
          <option value="">All Categories</option>
          <option *ngFor="let category of categories" [value]="category">
            {{ category | titlecase }}
          </option>
        </select>
      </div>

      <div class="filter-group">
        <button class="btn btn-secondary" (click)="clearFilters()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
          Clear Filters
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="loading">
    <div class="spinner"></div>
    <p>Loading products...</p>
  </div>

  <!-- Error State -->
  <div class="error-state" *ngIf="error && !loading">
    <div class="error-icon">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="15" y1="9" x2="9" y2="15"/>
        <line x1="9" y1="9" x2="15" y2="15"/>
      </svg>
    </div>
    <p class="error-message">{{ error }}</p>
    <button class="btn btn-secondary" (click)="loadProducts()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="23 4 23 10 17 10"/>
        <polyline points="1 20 1 14 7 14"/>
        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
      </svg>
      Try Again
    </button>
  </div>

  <!-- Product Form (Create/Edit) -->
  <div class="product-form-overlay" *ngIf="showCreateForm || showEditForm">
    <div class="product-form-container">
      <div class="form-header">
        <h2>{{ showEditForm ? "Edit Product" : "Add New Product" }}</h2>
        <button class="close-btn" (click)="closeForm()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <form [formGroup]="productForm" (ngSubmit)="onSubmit()" class="product-form-content">
        <!-- Basic Information -->
        <div class="form-section">
          <h3 class="section-title">Basic Information</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label for="title">Product Title *</label>
              <input
                type="text"
                id="title"
                formControlName="title"
                class="form-control"
                placeholder="Enter product title"
                [class.error]="productForm.get('title')?.invalid && productForm.get('title')?.touched"
              />
              <div class="error-message" *ngIf="productForm.get('title')?.invalid && productForm.get('title')?.touched">
                Title is required (min 3 characters)
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="description">Description *</label>
              <textarea
                id="description"
                formControlName="description"
                rows="4"
                class="form-control"
                placeholder="Enter product description"
                [class.error]="productForm.get('description')?.invalid && productForm.get('description')?.touched"
              ></textarea>
              <div class="error-message" *ngIf="productForm.get('description')?.invalid && productForm.get('description')?.touched">
                Description is required (min 10 characters)
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="price">Price (BDT) *</label>
              <div class="input-group">
                <span class="input-group-text">à§³</span>
                <input
                  type="number"
                  id="price"
                  formControlName="price"
                  step="0.01"
                  min="0"
                  class="form-control"
                  placeholder="0.00"
                  [class.error]="productForm.get('price')?.invalid && productForm.get('price')?.touched"
                />
              </div>
              <div class="error-message" *ngIf="productForm.get('price')?.invalid && productForm.get('price')?.touched">
                Valid price is required (minimum 0)
              </div>
            </div>

            <div class="form-group">
              <label for="stock">Stock Quantity *</label>
              <input
                type="number"
                id="stock"
                formControlName="stock"
                min="0"
                class="form-control"
                placeholder="0"
                [class.error]="productForm.get('stock')?.invalid && productForm.get('stock')?.touched"
              />
              <div class="error-message" *ngIf="productForm.get('stock')?.invalid && productForm.get('stock')?.touched">
                Stock quantity is required (minimum 0)
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="category">Category *</label>
              <select
                id="category"
                formControlName="category"
                class="form-control"
                [class.error]="productForm.get('category')?.invalid && productForm.get('category')?.touched"
              >
                <option value="">Select a category</option>
                <option *ngFor="let category of categories" [value]="category">
                  {{ category | titlecase }}
                </option>
              </select>
              <div class="error-message" *ngIf="productForm.get('category')?.invalid && productForm.get('category')?.touched">
                Category is required
              </div>
            </div>

            <div class="form-group checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" formControlName="active" />
                <span class="checkmark"></span>
                <span class="checkbox-text">Active Product</span>
              </label>
            </div>
          </div>
        </div>

        <!-- Media Upload Section -->
        <div class="form-section">
          <h3 class="section-title">Product Images</h3>
          
          <!-- Use MediaUploadComponent (same as community posts) -->
          <app-media-upload
            [entityType]="'product'"
            [maxFiles]="10"
            (filesUploaded)="onMediaUploaded($event)"
            (uploadComplete)="onMediaUploadComplete()"
            (uploadError)="onMediaUploadError($event)"
          ></app-media-upload>

          <!-- Uploaded Images Preview Summary -->
          <div class="uploaded-summary" *ngIf="uploadedMedia.length > 0" style="margin-top: 20px;">
            <div class="summary-header">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
              </svg>
              <span>{{ uploadedMedia.length }} image(s) ready for product</span>
            </div>
            <div class="preview-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-top: 10px;">
              <div *ngFor="let media of uploadedMedia" class="mini-preview" style="position: relative; border: 2px solid #4CAF50; border-radius: 8px; overflow: hidden; aspect-ratio: 1;">
                <img 
                  [src]="mediaService.getMediaUrlById(media.id)" 
                  [alt]="media.originalFilename"
                  style="width: 100%; height: 100%; object-fit: cover;"
                  (error)="handleImageError($event)"
                />
              </div>
            </div>
          </div>

          <!-- Manual Image URLs (Optional - for backward compatibility) -->
          <div class="manual-urls" style="margin-top: 20px;">
            <label for="imageUrls">Additional Image URLs (Optional)</label>
            <input
              type="text"
              id="imageUrls"
              formControlName="imageUrls"
              class="form-control"
              placeholder="https://example.com/image1.jpg, https://example.com/image2.jpg"
            />
            <small class="form-help">Enter comma-separated URLs for additional images</small>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="closeForm()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
            Cancel
          </button>

          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="productForm.invalid"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
              <polyline points="17 21 17 13 7 13 7 21"/>
              <polyline points="7 3 7 8 15 8"/>
            </svg>
            {{ showEditForm ? "Update Product" : "Create Product" }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Products List -->
  <div class="products-section" *ngIf="!loading && !error && !showCreateForm && !showEditForm">
    <div class="section-header">
      <h2>Products ({{ totalElements }})</h2>
      <div class="view-controls">
        <button class="btn btn-sm btn-secondary">Grid View</button>
        <button class="btn btn-sm btn-secondary">List View</button>
      </div>
    </div>

    <div class="products-grid">
      <div class="product-card" *ngFor="let product of products">
        <div class="product-image">
          <img
            [src]="product.images && product.images.length > 0 ? product.images[0] : getAdminPlaceholder()"
            [alt]="product.name"
            (error)="handleImageError($event)"
          />
          <div class="product-badge" [class]="getStockClass(product.stockQuantity)">
            {{ getStockStatus(product.stockQuantity) }}
          </div>
        </div>

        <div class="product-info">
          <h3 class="product-title">{{ product.name }}</h3>
          <p class="product-category">{{ product.category | titlecase }}</p>
          <p class="product-price">{{ formatPrice(product.price) }}</p>
          <div class="product-stats">
            <span class="stat">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
              0 views
            </span>
            <span class="stat">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
              </svg>
              0/5
            </span>
          </div>
        </div>

        <div class="product-actions">
          <button class="btn btn-sm btn-secondary" (click)="openEditForm(product)">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
            Edit
          </button>

          <button
            class="btn btn-sm"
            [class.btn-danger]="product.isAvailable"
            [class.btn-success]="!product.isAvailable"
            (click)="toggleProductStatus(product)"
          >
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"/>
              <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"/>
            </svg>
            {{ product.isAvailable ? "Deactivate" : "Activate" }}
          </button>

          <button class="btn btn-sm btn-danger" (click)="deleteProduct(product)">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"/>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
            Delete
          </button>
        </div>
      </div>
    </div>

    <!-- Pagination -->
    <div class="pagination" *ngIf="totalPages > 1">
      <button
        class="btn btn-sm"
        [disabled]="currentPage === 0"
        (click)="onPageChange(currentPage - 1)"
      >
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"/>
        </svg>
        Previous
      </button>

      <div class="page-numbers">
        <button
          *ngFor="let page of getPageNumbers()"
          class="btn btn-sm"
          [class.active]="page === currentPage"
          (click)="onPageChange(page)"
        >
          {{ page + 1 }}
        </button>
      </div>

      <button
        class="btn btn-sm"
        [disabled]="currentPage >= totalPages - 1"
        (click)="onPageChange(currentPage + 1)"
      >
        Next
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="9 18 15 12 9 6"/>
        </svg>
      </button>
    </div>
  </div>
</div>