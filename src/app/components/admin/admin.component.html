<div class="admin-container">
  <!-- Header -->
  <header class="admin-header fade-in">
    <div class="header-content">
      <div class="header-title">
        <h1>Admin Dashboard</h1>
        <p>Manage users and system settings</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-primary" (click)="openCreateUserModal()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <line x1="19" y1="8" x2="24" y2="13"></line>
            <line x1="21.5" y1="10.5" x2="21.5" y2="10.5"></line>
          </svg>
          Create User
        </button>
        <a routerLink="/dashboard" class="btn btn-secondary">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9,22 9,12 15,12 15,22"></polyline>
          </svg>
          Back to Dashboard
        </a>
      </div>
    </div>
  </header>

  <!-- Navigation Tabs -->
  <nav class="admin-nav fade-in">
    <div class="nav-tabs">
      <button 
        class="nav-tab" 
        [class.active]="activeTab === 'overview'"
        (click)="setActiveTab('overview')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="9" y1="9" x2="15" y2="9"></line>
          <line x1="9" y1="15" x2="15" y2="15"></line>
        </svg>
        Overview
      </button>
      <button 
        class="nav-tab" 
        [class.active]="activeTab === 'users'"
        (click)="setActiveTab('users')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
        Users
      </button>
    </div>
  </nav>

  <!-- Messages -->
  <div class="messages-container" *ngIf="successMessage || errorMessage">
    <div class="message success-message" *ngIf="successMessage">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <polyline points="20,6 9,17 4,12"></polyline>
      </svg>
      {{ successMessage }}
    </div>
    <div class="message error-message" *ngIf="errorMessage">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="15" y1="9" x2="9" y2="15"></line>
        <line x1="9" y1="9" x2="15" y2="15"></line>
      </svg>
      {{ errorMessage }}
    </div>
  </div>

  <!-- Debug Information (Remove in production) -->
  <div class="debug-info" style="background: rgba(255,255,255,0.1); padding: 1rem; margin: 1rem 0; border-radius: 8px; font-family: monospace; font-size: 12px;">
    <h4>Debug Information:</h4>
    <p><strong>Active Tab:</strong> {{ activeTab }}</p>
    <p><strong>System Stats:</strong> {{ systemStats ? 'Loaded' : 'Not loaded' }}</p>
    <p><strong>Users Count:</strong> {{ users.length }}</p>
    <p><strong>Filtered Users:</strong> {{ filteredUsers.length }}</p>
    <p><strong>Loading Stats:</strong> {{ isStatsLoading }}</p>
    <p><strong>Loading Users:</strong> {{ isLoading }}</p>
    <p><strong>Current User Admin:</strong> {{ isCurrentUserAdminDebug() }}</p>
  </div>

  <!-- Main Content -->
  <main class="admin-main">
    <!-- Overview Tab -->
    <div class="tab-content" *ngIf="activeTab === 'overview'">
      <div class="stats-grid fade-in">
        <div class="stat-card" *ngIf="systemStats">
          <div class="stat-icon">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
          </div>
          <div class="stat-info">
            <h3>Total Users</h3>
            <div class="stat-value">{{ systemStats.totalUsers }}</div>
          </div>
        </div>

        <div class="stat-card" *ngIf="systemStats">
          <div class="stat-icon admin">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
            </svg>
          </div>
          <div class="stat-info">
            <h3>Admin Users</h3>
            <div class="stat-value">{{ systemStats.adminUsers }}</div>
          </div>
        </div>

        <div class="stat-card" *ngIf="systemStats">
          <div class="stat-icon regular">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </div>
          <div class="stat-info">
            <h3>Regular Users</h3>
            <div class="stat-value">{{ systemStats.regularUsers }}</div>
          </div>
        </div>

        <div class="stat-card" *ngIf="systemStats">
          <div class="stat-icon time">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12,6 12,12 16,14"></polyline>
            </svg>
          </div>
          <div class="stat-info">
            <h3>Last Updated</h3>
            <div class="stat-value">{{ systemStats.timestamp | date:'short' }}</div>
          </div>
        </div>
      </div>

      <!-- Loading state for stats -->
      <div class="loading-container" *ngIf="isStatsLoading">
        <div class="loading-spinner"></div>
        <p>Loading system statistics...</p>
      </div>
    </div>

    <!-- Users Tab -->
    <div class="tab-content" *ngIf="activeTab === 'users'">
      <!-- User Controls -->
      <div class="user-controls fade-in">
        <div class="search-container">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <input 
            type="text" 
            placeholder="Search users..." 
            [value]="userFilter.search"
            (input)="onSearchInputChange($event)"
            class="search-input">
        </div>
        
        <div class="filter-container">
          <select 
            [value]="userFilter.role"
            (change)="onRoleSelectChange($event)"
            class="filter-select">
            <option value="">All Roles</option>
            <option value="USER">Users</option>
            <option value="ADMIN">Admins</option>
          </select>
        </div>
      </div>

      <!-- Users Table -->
      <div class="table-container fade-in">
        <div class="table-wrapper">
          <table class="users-table">
            <thead>
              <tr>
                <th (click)="onSortChange('userName')" class="sortable">
                  Username
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <polyline points="6,9 12,15 18,9"></polyline>
                  </svg>
                </th>
                <th (click)="onSortChange('firstName')" class="sortable">
                  Name
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <polyline points="6,9 12,15 18,9"></polyline>
                  </svg>
                </th>
                <th (click)="onSortChange('email')" class="sortable">
                  Email
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <polyline points="6,9 12,15 18,9"></polyline>
                  </svg>
                </th>
                <th>Roles</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let user of filteredUsers" class="user-row">
                <td class="username-cell">
                  <div class="user-avatar">
                    {{ user.firstName.charAt(0) }}{{ user.lastName.charAt(0) }}
                  </div>
                  {{ user.userName }}
                </td>
                <td>{{ user.firstName }} {{ user.lastName }}</td>
                <td>{{ user.email }}</td>
                <td>
                  <div class="roles-container">
                    <span 
                      *ngFor="let role of user.roles" 
                      class="role-badge"
                      [class.admin-role]="role === 'ADMIN'"
                      [class.user-role]="role === 'USER'">
                      {{ role }}
                    </span>
                  </div>
                </td>
                <td>
                  <div class="action-buttons">
                    <button 
                      class="btn btn-sm btn-outline"
                      (click)="openEditRolesModal(user)"
                      title="Edit Roles">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                      </svg>
                    </button>
                    <button 
                      class="btn btn-sm btn-outline"
                      (click)="openResetPasswordModal(user)"
                      title="Reset Password">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <circle cx="12" cy="16" r="1"></circle>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                      </svg>
                    </button>
                    <button 
                      *ngIf="!isUserAdmin(user)"
                      class="btn btn-sm btn-success"
                      (click)="promoteToAdmin(user)"
                      title="Promote to Admin">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <polyline points="15,3 21,3 21,9"></polyline>
                        <polyline points="9,21 3,21 3,15"></polyline>
                        <line x1="21" y1="3" x2="14" y2="10"></line>
                        <line x1="3" y1="21" x2="10" y2="14"></line>
                      </svg>
                    </button>
                    <button 
                      *ngIf="user.userName !== getCurrentUser()"
                      class="btn btn-sm btn-danger"
                      (click)="openDeleteConfirmModal(user)"
                      title="Delete User">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <polyline points="3,6 5,6 21,6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                      </svg>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Empty state -->
        <div class="empty-state" *ngIf="!isLoading && filteredUsers.length === 0">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
          <h3>No users found</h3>
          <p>Try adjusting your search or filter criteria</p>
        </div>
      </div>

      <!-- Loading state for users -->
      <div class="loading-container" *ngIf="isLoading">
        <div class="loading-spinner"></div>
        <p>Loading users...</p>
      </div>
    </div>
  </main>
</div>

<!-- Create User Modal -->
<div class="modal-overlay" *ngIf="showCreateUserModal" (click)="closeCreateUserModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Create New User</h2>
      <button class="modal-close" (click)="closeCreateUserModal()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <form [formGroup]="createUserForm" (ngSubmit)="onCreateUser()" class="modal-form">
      <div class="form-group">
        <label for="userName">Username</label>
        <input 
          type="text" 
          id="userName"
          formControlName="userName"
          [class.error]="isFieldInvalid(createUserForm, 'userName')"
          placeholder="Enter username">
        <div class="field-error" *ngIf="isFieldInvalid(createUserForm, 'userName')">
          {{ getFieldError(createUserForm, 'userName') }}
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="firstName">First Name</label>
          <input 
            type="text" 
            id="firstName"
            formControlName="firstName"
            [class.error]="isFieldInvalid(createUserForm, 'firstName')"
            placeholder="Enter first name">
          <div class="field-error" *ngIf="isFieldInvalid(createUserForm, 'firstName')">
            {{ getFieldError(createUserForm, 'firstName') }}
          </div>
        </div>

        <div class="form-group">
          <label for="lastName">Last Name</label>
          <input 
            type="text" 
            id="lastName"
            formControlName="lastName"
            [class.error]="isFieldInvalid(createUserForm, 'lastName')"
            placeholder="Enter last name">
          <div class="field-error" *ngIf="isFieldInvalid(createUserForm, 'lastName')">
            {{ getFieldError(createUserForm, 'lastName') }}
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="email">Email</label>
        <input 
          type="email" 
          id="email"
          formControlName="email"
          [class.error]="isFieldInvalid(createUserForm, 'email')"
          placeholder="Enter email address">
        <div class="field-error" *ngIf="isFieldInvalid(createUserForm, 'email')">
          {{ getFieldError(createUserForm, 'email') }}
        </div>
      </div>

      <div class="form-group">
        <label for="password">Password</label>
        <input 
          type="password" 
          id="password"
          formControlName="password"
          [class.error]="isFieldInvalid(createUserForm, 'password')"
          placeholder="Enter password">
        <div class="field-error" *ngIf="isFieldInvalid(createUserForm, 'password')">
          {{ getFieldError(createUserForm, 'password') }}
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" (click)="closeCreateUserModal()">Cancel</button>
        <button type="submit" class="btn btn-primary" [disabled]="!createUserForm.valid || isLoading">
          <span *ngIf="!isLoading">Create User</span>
          <span *ngIf="isLoading">Creating...</span>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Roles Modal -->
<div class="modal-overlay" *ngIf="showEditRolesModal" (click)="closeEditRolesModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Edit User Roles</h2>
      <button class="modal-close" (click)="closeEditRolesModal()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <form [formGroup]="editRolesForm" (ngSubmit)="onUpdateRoles()" class="modal-form">
      <div class="user-info" *ngIf="selectedUser">
        <p><strong>User:</strong> {{ selectedUser.userName }}</p>
        <p><strong>Name:</strong> {{ selectedUser.firstName }} {{ selectedUser.lastName }}</p>
      </div>

      <div class="form-group">
        <label>Roles</label>
        <div class="checkbox-group">
          <label *ngFor="let role of availableRoles" class="checkbox-label">
            <input 
              type="checkbox" 
              [value]="role"
              [checked]="editRolesForm.value.roles?.includes(role)"
              (change)="onRoleToggle(role, $event)">
            <span class="checkmark"></span>
            {{ role }}
          </label>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" (click)="closeEditRolesModal()">Cancel</button>
        <button type="submit" class="btn btn-primary" [disabled]="!editRolesForm.valid || isLoading">
          <span *ngIf="!isLoading">Update Roles</span>
          <span *ngIf="isLoading">Updating...</span>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Reset Password Modal -->
<div class="modal-overlay" *ngIf="showResetPasswordModal" (click)="closeResetPasswordModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Reset Password</h2>
      <button class="modal-close" (click)="closeResetPasswordModal()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <form [formGroup]="resetPasswordForm" (ngSubmit)="onResetPassword()" class="modal-form">
      <div class="user-info" *ngIf="selectedUser">
        <p><strong>User:</strong> {{ selectedUser.userName }}</p>
      </div>

      <div class="form-group">
        <label for="newPassword">New Password</label>
        <input 
          type="password" 
          id="newPassword"
          formControlName="newPassword"
          [class.error]="isFieldInvalid(resetPasswordForm, 'newPassword')"
          placeholder="Enter new password">
        <div class="field-error" *ngIf="isFieldInvalid(resetPasswordForm, 'newPassword')">
          {{ getFieldError(resetPasswordForm, 'newPassword') }}
        </div>
      </div>

      <div class="form-group">
        <label for="confirmPassword">Confirm Password</label>
        <input 
          type="password" 
          id="confirmPassword"
          formControlName="confirmPassword"
          [class.error]="isFieldInvalid(resetPasswordForm, 'confirmPassword')"
          placeholder="Confirm new password">
        <div class="field-error" *ngIf="isFieldInvalid(resetPasswordForm, 'confirmPassword')">
          {{ getFieldError(resetPasswordForm, 'confirmPassword') }}
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" (click)="closeResetPasswordModal()">Cancel</button>
        <button type="submit" class="btn btn-primary" [disabled]="!resetPasswordForm.valid || isLoading">
          <span *ngIf="!isLoading">Reset Password</span>
          <span *ngIf="isLoading">Resetting...</span>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" *ngIf="showDeleteConfirmModal" (click)="closeDeleteConfirmModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Confirm Delete</h2>
      <button class="modal-close" (click)="closeDeleteConfirmModal()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="modal-content">
      <div class="delete-warning" *ngIf="selectedUser">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="15" y1="9" x2="9" y2="15"></line>
          <line x1="9" y1="9" x2="15" y2="15"></line>
        </svg>
        <h3>Delete User</h3>
        <p>Are you sure you want to delete user <strong>{{ selectedUser.userName }}</strong>?</p>
        <p class="warning-text">This action cannot be undone.</p>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" (click)="closeDeleteConfirmModal()">Cancel</button>
        <button type="button" class="btn btn-danger" (click)="onDeleteUser()" [disabled]="isLoading">
          <span *ngIf="!isLoading">Delete User</span>
          <span *ngIf="isLoading">Deleting...</span>
        </button>
      </div>
    </div>
  </div>
</div>