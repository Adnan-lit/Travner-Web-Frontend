<div class="chat-layout">
  <!-- Sidebar: Conversations List -->
  <aside class="sidebar" aria-label="Conversations list">
    <header class="sidebar-header">
      <h2>Chat</h2>
      <div class="sidebar-actions">
        <button
          (click)="openNewChatModal()"
          class="new-chat-btn"
          title="Start new conversation"
        >
          âœš New Chat
        </button>
        <button
          (click)="reconnectWebSocket()"
          [class.connected]="isConnected$ | async"
          title="WebSocket status"
          class="ws-status-btn"
        >
          {{ (isConnected$ | async) ? "ðŸŸ¢" : "ðŸ”´" }}
        </button>
      </div>
    </header>

    <!-- Search Conversations -->
    <div class="search-container">
      <input
        type="text"
        placeholder="Search conversations..."
        (input)="onSearchChange($any($event.target).value)"
        class="search-input"
      />
    </div>

    <!-- Conversations List -->
    <div class="conversations-container">
      <div
        class="conversation"
        *ngFor="
          let conv of filteredConversations$ | async;
          trackBy: trackConversation
        "
        [class.active]="(activeConversation$ | async)?.id === conv.id"
        (click)="selectConversation(conv)"
      >
        <div class="conversation-info">
          <div class="conversation-title">{{ getConversationTitle(conv) }}</div>
          <div class="conversation-meta">
            <span class="member-count">{{ conv.members.length }} members</span>
            <span class="unread-count" *ngIf="conv.unreadCount > 0">
              {{ conv.unreadCount }}
            </span>
          </div>
        </div>
      </div>

      <!-- Empty state -->
      <div *ngIf="(conversations$ | async)?.length === 0" class="empty-state">
        <div class="empty-icon">ðŸ’¬</div>
        <p>No conversations yet</p>
        <button (click)="openNewChatModal()" class="start-chat-btn">
          Start your first chat
        </button>
      </div>
    </div>
  </aside>

  <!-- Main Chat Area -->
  <main class="chat-main">
    <div
      *ngIf="!(activeConversation$ | async)"
      class="no-conversation-selected"
    >
      <div class="welcome-message">
        <h3>Welcome to Chat</h3>
        <p>Select a conversation from the sidebar or start a new one</p>
        <button (click)="openNewChatModal()" class="start-chat-btn">
          Start New Conversation
        </button>
      </div>
    </div>

    <div
      *ngIf="activeConversation$ | async as activeConversation"
      class="chat-active"
    >
      <!-- Chat Header -->
      <header class="chat-header">
        <div class="chat-title">
          <h3>{{ getConversationTitle(activeConversation) }}</h3>
          <div class="chat-meta">
            <span
              class="connection-status"
              [class.connected]="isConnected$ | async"
            >
              {{ (isConnected$ | async) ? "Connected" : "Connecting..." }}
            </span>
          </div>
        </div>
      </header>

      <!-- Messages Container -->
      <div class="messages-container" #messagesContainer>
        <div
          class="message"
          *ngFor="let message of messages$ | async; trackBy: trackMessage"
          [class.own-message]="isMyMessage(message) | async"
          [class.other-message]="!(isMyMessage(message) | async)"
        >
          <div class="message-header">
            <span class="sender-name">{{ message.senderName }}</span>
            <span class="timestamp">{{
              formatTimestamp(message.timestamp)
            }}</span>
          </div>
          <div class="message-content">{{ message.content }}</div>
        </div>

        <!-- No messages state -->
        <div *ngIf="(messages$ | async)?.length === 0" class="no-messages">
          <p>No messages yet. Start the conversation!</p>
        </div>
      </div>

      <!-- Message Input -->
      <div class="message-input-container">
        <div class="message-input-wrapper">
          <textarea
            [(ngModel)]="newMessage"
            (keydown)="onMessageKeyPress($event)"
            (input)="onTyping()"
            (blur)="onStoppedTyping()"
            placeholder="Type your message..."
            class="message-input"
            rows="1"
          ></textarea>
          <button
            (click)="sendMessage()"
            [disabled]="!newMessage.trim()"
            class="send-button"
            title="Send message"
          >
            âž¤
          </button>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- New Chat Modal -->
<div
  *ngIf="showNewChatModal"
  class="modal-overlay"
  (click)="closeNewChatModal()"
>
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Start New Conversation</h3>
      <button (click)="closeNewChatModal()" class="close-btn">âœ•</button>
    </div>
    <div class="modal-body">
      <label for="participant-input">Add participant:</label>
      <input
        id="participant-input"
        type="text"
        [(ngModel)]="newChatParticipant"
        placeholder="Enter username..."
        class="participant-input"
      />
    </div>
    <div class="modal-footer">
      <button (click)="closeNewChatModal()" class="cancel-btn">Cancel</button>
      <button
        (click)="createNewChat()"
        [disabled]="!newChatParticipant.trim()"
        class="create-btn"
      >
        Create Chat
      </button>
    </div>
  </div>
</div>
