<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Media Upload</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 4px; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
    </style>
</head>
<body>
    <h1>Test Media Upload</h1>
    
    <form id="uploadForm">
        <div class="form-group">
            <label for="title">Post Title:</label>
            <input type="text" id="title" name="title" value="Test Post with Image" required>
        </div>
        
        <div class="form-group">
            <label for="content">Post Content:</label>
            <textarea id="content" name="content" rows="4" required>This is a test post to verify image upload functionality.</textarea>
        </div>
        
        <div class="form-group">
            <label for="image">Select Image:</label>
            <input type="file" id="image" name="image" accept="image/*" required>
        </div>
        
        <button type="submit">Create Post with Image</button>
    </form>
    
    <div id="result" class="result" style="display: none;"></div>

    <script>
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const imageFile = document.getElementById('image').files[0];
            const resultDiv = document.getElementById('result');
            
            if (!imageFile) {
                showResult('Please select an image file.', 'error');
                return;
            }
            
            try {
                // Step 1: Create the post
                const postData = {
                    title: title,
                    content: content,
                    location: 'Test Location',
                    tags: ['test'],
                    published: true
                };
                
                const postResponse = await fetch('http://localhost:8080/api/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Basic ' + btoa('testuser:password123')
                    },
                    body: JSON.stringify(postData)
                });
                
                const postResult = await postResponse.json();
                console.log('Post created:', postResult);
                
                if (!postResult.success) {
                    showResult('Failed to create post: ' + postResult.message, 'error');
                    return;
                }
                
                const postId = postResult.data.id;
                showResult('Post created successfully with ID: ' + postId, 'success');
                
                // Step 2: Upload the image
                const formData = new FormData();
                formData.append('file', imageFile);
                formData.append('type', 'post');
                formData.append('entityId', postId);
                
                const mediaResponse = await fetch('http://localhost:8080/api/media/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Basic ' + btoa('testuser:password123')
                    },
                    body: formData
                });
                
                const mediaResult = await mediaResponse.json();
                console.log('Media uploaded:', mediaResult);
                
                if (mediaResult.success) {
                    showResult('Media uploaded successfully! Post ID: ' + postId + ', Media ID: ' + mediaResult.data.id, 'success');
                } else {
                    showResult('Failed to upload media: ' + mediaResult.message, 'error');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showResult('Error: ' + error.message, 'error');
            }
        });
        
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = message;
            resultDiv.className = 'result ' + type;
            resultDiv.style.display = 'block';
        }
    </script>
</body>
</html>

